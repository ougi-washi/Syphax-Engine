name: linux-build-test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Debug

jobs:
  linux-build-test:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential pkg-config
          sudo apt-get install -y libwayland-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libxkbcommon-dev
          sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev
          sudo apt-get install -y libpulse-dev libasound-dev libsndio-dev libjack-jackd2-dev

      - name: Build
        run: ./build.sh

      - name: Validate expected test binaries exist
        run: |
          test -x ./bin/context_lifecycle
          test -x ./bin/gltf_roundtrip
          test -x ./bin/rts_integration

      - name: Check example line budget
        run: ./scripts/check_example_line_budget.sh

      - name: Test (context lifecycle teardown regression)
        run: |
          timeout 25s env \
            SE_TERMINAL_RENDER=1 \
            SE_TERMINAL_HIDE_WINDOW=1 \
            ./bin/context_lifecycle

      - name: Test (GLTF GLB roundtrip)
        run: |
          timeout 15s ./bin/gltf_roundtrip

      - name: Test (rts_integration terminal autotest)
        run: |
          timeout 25s env \
            SE_TERMINAL_RENDER=1 \
            SE_TERMINAL_HIDE_WINDOW=1 \
            ./bin/rts_integration --autotest --seconds=2 --autotest-steps=20 --autotest-dt=0.05

      - name: Build (terminal platform rts_integration)
        run: ./build.sh -platform=terminal rts_integration

      - name: Test (rts_integration terminal platform autotest)
        run: |
          timeout 25s ./bin/rts_integration --autotest --seconds=2 --autotest-steps=20 --autotest-dt=0.05
